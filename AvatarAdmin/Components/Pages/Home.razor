@page "/"
<AuthGuard>
@using AvatarAdmin.Services
@using AvatarAdmin.Models
@inject AvatarApiClient Api
@inject AuthState Auth
@inject NavigationManager Nav

<PageTitle>Panel Avatar</PageTitle>

<section class="page-hero" role="region" aria-label="Resumen y accesos r√°pidos">
  <div class="hero-bg orb orb-1" aria-hidden="true"></div>
  <div class="hero-bg orb orb-2" aria-hidden="true"></div>

  <div class="hero-head">
    <h1>Panel del Avatar 3D</h1>

    <div class="hero-tags" aria-label="Datos de sesi√≥n">
      <span class="tag">@Auth.Email</span>
      <span class="tag">Rol: @Auth.Role</span>
      <span class="tag">@((Auth.Empresa ?? "‚Äî")) / @((Auth.Sede ?? "‚Äî"))</span>
      <span class="tag tag-quiet">Sesi√≥n: @FormatEta(Auth.TimeRemaining())</span>
    </div>
  </div>

  <p class="hero-sub">Consulta y gestiona la configuraci√≥n por empresa y sede. Cuando est√©s listo, abre el editor.</p>

  <div class="cta-row">
    <button class="btn btn-primary u-anim" @onclick="GoEditor" aria-label="Ir al editor de avatar">
      Ir al editor
    </button>
    @if (string.Equals(Auth.Role, "Admin", StringComparison.OrdinalIgnoreCase))
    {
      <button class="btn btn-outline-light u-anim" @onclick="GoConfigs" aria-label="Ver configuraciones">
        Ver configuraciones
      </button>
      <button class="btn btn-outline-light u-anim" @onclick="GoUsers" aria-label="Ir a gesti√≥n de usuarios">
        Gesti√≥n de usuarios
      </button>
    }
  </div>
</section>

<section class="card-grid" role="region" aria-label="Configuraci√≥n de avatar">
  <!-- Card: Empresa / Sede -->
  <div class="card">
    <header class="card-h">
      <h5>Empresa / Sede</h5>
      <p class="text-muted">Selecciona el √°mbito que quieres revisar</p>
    </header>

    <div class="form-row">
      <label class="form-label" for="empresa-input">Empresa</label>
      <div class="input-icon">
        <span class="ii" aria-hidden="true">üè¢</span>
        <input id="empresa-input" class="form-control" @bind="empresa" autocomplete="organization" disabled="@(!Auth.IsAdmin)" />
      </div>
    </div>

    <div class="form-row">
      <label class="form-label" for="sede-input">Sede</label>
      <div class="input-icon">
        <span class="ii" aria-hidden="true">üìç</span>
        <input id="sede-input" class="form-control" @bind="sede" autocomplete="section" disabled="@(!Auth.IsAdmin)" />
      </div>
    </div>

    <div class="mt-3 d-grid">
      <button class="btn btn-primary u-anim" @onclick="LoadAsync" disabled="@loading" aria-busy="@loading">
        @(loading ? "Cargando..." : "Cargar configuraci√≥n")
      </button>
    </div>
  </div>

  <!-- Card: Configuraci√≥n actual -->
  <div class="card card--wide">
    <div class="card-title-row">
      <h5>Configuraci√≥n actual</h5>
      @if (cfg is not null)
      {
        <small class="text-muted">ID: @cfg.Id</small>
      }
    </div>

    @if (loading)
    {
      <div class="skeleton" aria-live="polite">
        <div class="skeleton-line w-60"></div>
        <div class="skeleton-line w-40"></div>
        <div class="skeleton-grid">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
        </div>
      </div>
    }
    else if (error is not null)
    {
      <div class="alert alert-danger mt-2" role="alert">@error</div>
    }
    else if (cfg is null)
    {
      <div class="empty">
        <div class="empty-illustration" aria-hidden="true">üóÇÔ∏è</div>
        <p class="empty-text">Sin datos. Indica empresa y sede y pulsa <strong>‚ÄúCargar configuraci√≥n‚Äù</strong>.</p>
      </div>
    }
    else
    {
      <div class="kv" role="table" aria-label="Detalles de configuraci√≥n cargada">
        <div role="row"><span role="rowheader">Vestimenta</span><code role="cell">@cfg.Vestimenta</code></div>
        <div role="row"><span role="rowheader">Fondo</span><code role="cell">@cfg.Fondo</code></div>
        <div role="row"><span role="rowheader">Proveedor TTS</span><code role="cell">@cfg.ProveedorTts</code></div>
        <div role="row"><span role="rowheader">Voz</span><code role="cell">@cfg.Voz</code></div>
        <div role="row"><span role="rowheader">Idioma</span><code role="cell">@cfg.Idioma</code></div>
        <div role="row"><span role="rowheader">Color Cabello</span><code role="cell">@cfg.ColorCabello</code></div>

        <div class="kv-logo" role="row">
          <span role="rowheader">Logo</span>
          <div class="logo-row" role="cell">
            <code class="logo-path" title="@cfg.LogoPath">@cfg.LogoPath</code>
            @if (!string.IsNullOrWhiteSpace(cfg.LogoPath))
            {
              <img src="@Abs(cfg.LogoPath)" alt="Logo cargado" class="logo-preview" />
            }
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex justify-content-end">
        <button class="btn btn-primary u-anim" @onclick="GoEditor" aria-label="Abrir editor">
          Abrir editor
        </button>
      </div>
    }
  </div>
</section>

@code {
  private string empresa = "ACME";
  private string sede = "CENTRO";

  private bool loading;
  private string? error;
  private AvatarConfigDto? cfg;

  // Convierte rutas relativas del backend en absolutas
  private string Abs(string? path)
  {
    if (string.IsNullOrWhiteSpace(path)) return "";
    if (Uri.TryCreate(path, UriKind.Absolute, out var abs)) return abs.ToString();
    var baseUrl = Api.BaseUrl?.TrimEnd('/') ?? "";
    return string.IsNullOrEmpty(baseUrl) ? path : $"{baseUrl}/{path.TrimStart('/')}";
  }

  protected override void OnInitialized()
  {
    if (!string.IsNullOrWhiteSpace(Auth.Empresa)) empresa = Auth.Empresa!;
    if (!string.IsNullOrWhiteSpace(Auth.Sede))    sede    = Auth.Sede!;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;

    await Auth.EnsureHydratedAsync();

    if (Auth.IsAuthenticated && !string.IsNullOrWhiteSpace(empresa) && !string.IsNullOrWhiteSpace(sede))
    {
      await LoadAsync();
    }
  }

  private async Task LoadAsync()
  {
    loading = true; error = null; cfg = null; StateHasChanged();
    try
    {
      cfg = await Api.GetConfigAsync(empresa, sede);
      if (cfg is null)
      {
        error = "No existe una configuraci√≥n para esta empresa/sede.";
      }
    }
    catch (Exception ex) { error = ex.Message; }
    finally { loading = false; StateHasChanged(); }
  }

  private void GoEditor() => Nav.NavigateTo("/editor");
  private void GoConfigs() => Nav.NavigateTo("/configs");
  private void GoUsers()  => Nav.NavigateTo("/users");

  private static string FormatEta(TimeSpan? ts)
  {
    if (ts is null || ts.Value <= TimeSpan.Zero) return "‚Äî";
    var t = ts.Value;
    return t.TotalHours >= 1
      ? $"{(int)t.TotalHours}h {t.Minutes}m"
      : $"{t.Minutes}m {t.Seconds}s";
  }
}
</AuthGuard>
