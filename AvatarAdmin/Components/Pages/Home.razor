@page "/"
<AuthGuard>
@using AvatarAdmin.Services
@using AvatarAdmin.Models
@inject AvatarApiClient Api
@inject AuthState Auth
@inject NavigationManager Nav

<PageTitle>Panel Avatar</PageTitle>

<section class="page-hero">
  <div class="hero-head">
    <h1>Panel del Avatar 3D</h1>
    <div class="hero-tags">
      <span class="tag">@Auth.Email</span>
      <span class="tag">Rol: @Auth.Role</span>
      <span class="tag">@((Auth.Empresa ?? "—")) / @((Auth.Sede ?? "—"))</span>
      <span class="tag tag-quiet">Sesión: @FormatEta(Auth.TimeRemaining())</span>
    </div>
  </div>

  <p>Consulta y gestiona la configuración por empresa y sede. Cuando estés listo, abre el editor.</p>

  <div class="cta-row">
    <button class="btn btn-primary" @onclick="GoEditor">Ir al editor</button>
    @if (string.Equals(Auth.Role, "Admin", StringComparison.OrdinalIgnoreCase))
    {
      <button class="btn btn-outline-light" @onclick="GoUsers">Gestión de usuarios</button>
    }
  </div>
</section>

<section class="card-grid">
  <!-- Card: Empresa / Sede -->
  <div class="card" style="grid-column: span 4;">
    <h5>Empresa / Sede</h5>
    <p class="text-muted">Selecciona el ámbito que quieres revisar.</p>

    <div class="mt-2">
      <label class="form-label">Empresa</label>
      <input class="form-control" @bind="empresa" />
    </div>
    <div class="mt-2">
      <label class="form-label">Sede</label>
      <input class="form-control" @bind="sede" />
    </div>
    <div class="mt-3 d-grid">
      <button class="btn btn-primary" @onclick="LoadAsync" disabled="@loading">
        @(loading ? "Cargando..." : "Cargar configuración")
      </button>
    </div>
  </div>

  <!-- Card: Configuración actual -->
  <div class="card" style="grid-column: span 8;">
    <div class="card-title-row">
      <h5>Configuración actual</h5>
      @if (cfg is not null)
      {
        <small class="text-muted">ID: @cfg.Id</small>
      }
    </div>

    @if (loading)
    {
      <div class="skeleton">
        <div class="skeleton-line w-60"></div>
        <div class="skeleton-line w-40"></div>
        <div class="skeleton-grid">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
        </div>
      </div>
    }
    else if (error is not null)
    {
      <div class="alert alert-danger mt-2">@error</div>
    }
    else if (cfg is null)
    {
      <div class="text-muted mt-2">Sin datos. Indica empresa y sede y pulsa “Cargar configuración”.</div>
    }
    else
    {
      <div class="kv">
        <div><span>Vestimenta</span><code>@cfg.Vestimenta</code></div>
        <div><span>Fondo</span><code>@cfg.Fondo</code></div>
        <div><span>Proveedor TTS</span><code>@cfg.ProveedorTts</code></div>
        <div><span>Voz</span><code>@cfg.Voz</code></div>
        <div><span>Idioma</span><code>@cfg.Idioma</code></div>
        <div><span>Color Cabello</span><code>@cfg.ColorCabello</code></div>
        <div class="kv-logo">
          <span>Logo</span>
          <div class="logo-row">
            <code class="logo-path">@cfg.LogoPath</code>
            @if (!string.IsNullOrWhiteSpace(cfg.LogoPath))
            {
              <img src="@cfg.LogoPath" alt="Logo" class="logo-preview" />
            }
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex justify-content-end">
        <button class="btn btn-primary" @onclick="GoEditor">Abrir editor</button>
      </div>
    }
  </div>
</section>

@code {
  private string empresa = "ACME";
  private string sede = "CENTRO";

  private bool loading;
  private string? error;
  private AvatarConfigDto? cfg;

  protected override void OnInitialized()
  {
    if (!string.IsNullOrWhiteSpace(Auth.Empresa)) empresa = Auth.Empresa!;
    if (!string.IsNullOrWhiteSpace(Auth.Sede))    sede    = Auth.Sede!;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender && !string.IsNullOrWhiteSpace(empresa) && !string.IsNullOrWhiteSpace(sede))
    {
      await LoadAsync();
    }
  }

  private async Task LoadAsync()
  {
    loading = true; error = null; cfg = null; StateHasChanged();
    try { cfg = await Api.GetConfigAsync(empresa, sede); }
    catch (Exception ex) { error = ex.Message; }
    finally { loading = false; StateHasChanged(); }
  }

  private void GoEditor() => Nav.NavigateTo("/editor");
  private void GoUsers()  => Nav.NavigateTo("/users");

  private static string FormatEta(TimeSpan? ts)
  {
    if (ts is null || ts.Value <= TimeSpan.Zero) return "—";
    var t = ts.Value;
    return t.TotalHours >= 1
      ? $"{(int)t.TotalHours}h {t.Minutes}m"
      : $"{t.Minutes}m {t.Seconds}s";
  }
}
</AuthGuard>
