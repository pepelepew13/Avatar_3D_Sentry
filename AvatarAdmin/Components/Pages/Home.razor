@page "/"
@using System.ComponentModel.DataAnnotations
@implements IAsyncDisposable
@inject AvatarApiClient ApiClient
@inject ILogger<Home> Logger
@inject IJSRuntime JS

<PageTitle>Panel del avatar</PageTitle>

<div class="editor-page">
    <section class="header-card">
        <h1>Asistente 3D para turnos Sentry</h1>
        <p>Personaliza el avatar que anunciar√° los turnos en sala: configura su vestimenta, idioma, voz, fondo y logo corporativo desde un mismo panel.</p>

        <EditForm class="selector-form" FormName="selector-config" Model="@selector" OnValidSubmit="LoadConfigAsync">
            <DataAnnotationsValidator />
            <div class="field-group">
                <label for="empresaInput">Empresa</label>
                <InputText id="empresaInput" class="form-control" @bind-Value="selector.Empresa" placeholder="Ej. sentry" />
                <ValidationMessage For="@(() => selector.Empresa)" />
            </div>
            <div class="field-group">
                <label for="sedeInput">Sede</label>
                <InputText id="sedeInput" class="form-control" @bind-Value="selector.Sede" placeholder="Ej. pereira" />
                <ValidationMessage For="@(() => selector.Sede)" />
            </div>
            <button type="submit" class="btn btn-primary" disabled="@isLoading">
                @(isLoading ? "Cargando..." : "Cargar configuraci√≥n")
            </button>
        </EditForm>
    </section>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert-panel">@errorMessage</div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="success-panel">@successMessage</div>
    }

    @if (config is null)
    {
        <section class="editor-card">
            <h2>Comienza seleccionando una empresa</h2>
            <p>Ingresa la empresa y la sede para cargar o crear una configuraci√≥n. Podr√°s ajustar logo, idioma y apariencia inmediatamente.</p>
        </section>
    }
    else
    {
        <section class="config-summary-card">
            <header>
                <h2>@config.Empresa ‚Äî @config.Sede</h2>
                <p>La configuraci√≥n est√° lista. Abre el panel flotante para revisarla o realizar ajustes r√°pidos.</p>
            </header>
            <dl class="summary-grid">
                <div>
                    <dt>Vestimenta</dt>
                    <dd>@GetOutfitLabel(config.Vestimenta)</dd>
                </div>
                <div>
                    <dt>Fondo</dt>
                    <dd>@GetBackgroundLabel(config.Fondo)</dd>
                </div>
                <div>
                    <dt>Idioma</dt>
                    <dd>@GetLanguageLabel(config.Idioma)</dd>
                </div>
                <div>
                    <dt>Logo</dt>
                    <dd>@(string.IsNullOrWhiteSpace(CurrentLogoUrl) ? "Sin logo" : "Logo aplicado")</dd>
                </div>
            </dl>
            <div class="summary-actions">
                <button type="button" class="btn btn-primary" @onclick="OpenEditor">Abrir personalizaci√≥n</button>
            </div>
        </section>

        @if (showEditorModal)
        {
            <div class="editor-modal-backdrop" @onclick="async () => await CloseEditorAsync(false)">
                <div class="editor-modal" role="dialog" aria-modal="true" aria-label="Editor del avatar" @onclick:stopPropagation>
                    <header class="editor-modal-header">
                        <div>
                            <h2>Personalizaci√≥n del avatar</h2>
                            <p>Ajusta vestimenta, voz, logo y fondo desde este panel inspirado en editores de juegos.</p>
                        </div>
                        <button type="button" class="modal-close" aria-label="Cerrar" @onclick="async () => await CloseEditorAsync(false)">‚úï</button>
                    </header>

                    <div class="editor-modal-body">
                        <div class="editor-shell game-layout">
                            <aside class="editor-sidebar">
                                <div class="sidebar-header">
                                    <h2>Modo personalizaci√≥n</h2>
                                    <p>Selecciona un m√≥dulo para ajustar la experiencia del avatar como si armaras un personaje de videojuego.</p>
                                </div>

                                <nav class="sidebar-actions">
                                    <button type="button" class="@GetSidebarButtonClass(PanelIdentity)" @onclick="() => SetActivePanel(PanelIdentity)" disabled="@isSaving">
                                        <span class="sidebar-icon" aria-hidden="true">üé®</span>
                                        <span class="sidebar-label">
                                            <strong>Identidad</strong>
                                            <small>Logo y escudo</small>
                                        </span>
                                    </button>
                                    <button type="button" class="@GetSidebarButtonClass(PanelOutfit)" @onclick="() => SetActivePanel(PanelOutfit)" disabled="@isSaving">
                                        <span class="sidebar-icon" aria-hidden="true">üß•</span>
                                        <span class="sidebar-label">
                                            <strong>Vestuario</strong>
                                            <small>Ropa y cabello</small>
                                        </span>
                                    </button>
                                    <button type="button" class="@GetSidebarButtonClass(PanelVoice)" @onclick="() => SetActivePanel(PanelVoice)" disabled="@isSaving">
                                        <span class="sidebar-icon" aria-hidden="true">üé§</span>
                                        <span class="sidebar-label">
                                            <strong>Voz</strong>
                                            <small>Idioma y locuci√≥n</small>
                                        </span>
                                    </button>
                                    <button type="button" class="@GetSidebarButtonClass(PanelBackground)" @onclick="() => SetActivePanel(PanelBackground)" disabled="@isSaving">
                                        <span class="sidebar-icon" aria-hidden="true">üåÜ</span>
                                        <span class="sidebar-label">
                                            <strong>Escenograf√≠a</strong>
                                            <small>Fondos din√°micos</small>
                                        </span>
                                    </button>
                                </nav>

                                <div class="sidebar-summary">
                                    <h3>Resumen</h3>
                                    <dl>
                                        <div>
                                            <dt>Empresa</dt>
                                            <dd>@config.Empresa</dd>
                                        </div>
                                        <div>
                                            <dt>Sede</dt>
                                            <dd>@config.Sede</dd>
                                        </div>
                                        <div>
                                            <dt>Vestimenta</dt>
                                            <dd>@GetOutfitLabel(config.Vestimenta)</dd>
                                        </div>
                                        <div>
                                            <dt>Fondo</dt>
                                            <dd>@GetBackgroundLabel(config.Fondo)</dd>
                                        </div>
                                    </dl>
                                </div>
                            </aside>

                            <section class="preview-stage">
                                <header class="stage-header">
                                    <div>
                                        <h2>Vista previa</h2>
                                        <p>Observa al avatar en tiempo real mientras aplicas cada cambio.</p>
                                    </div>
                                    <div class="stage-tags">
                                        <span class="stage-tag">@GetLanguageLabel(config.Idioma)</span>
                                        <span class="stage-tag">@(string.IsNullOrWhiteSpace(config.Voz) ? "Sin voz" : config.Voz)</span>
                                    </div>
                                </header>

                                <div class="stage-canvas @GetPreviewClass()">
                                    <canvas class="avatar-viewer-canvas" @ref="avatarCanvasRef"></canvas>
                                    <div class="viewer-overlay stage-overlay">
                                        <div class="viewer-pill">Logo @(string.IsNullOrWhiteSpace(CurrentLogoUrl) ? "pendiente" : "aplicado")</div>
                                        <div class="viewer-pill">@GetOutfitLabel(config.Vestimenta)</div>
                                    </div>
                                </div>

                                <footer class="stage-toolbar gamebar">
                                    <div class="gamebar-left">
                                        <button type="button" class="icon-btn" title="Girar 360¬∞" @onclick="TurntableAsync">‚ü≥</button>
                                        <button type="button" class="icon-btn" title="Centrar" @onclick="FrameAsync">‚äï</button>
                                        <button type="button" class="icon-btn" title="Captura" @onclick="ScreenshotAsync">üì∑</button>
                                    </div>

                                    <div class="gamebar-mid">
                                        <span class="kbd">W</span><span class="kbd">A</span><span class="kbd">S</span><span class="kbd">D</span>
                                        <span class="hint">mover</span>
                                        <span class="sep"></span>
                                        <span class="kbd">Wheel</span><span class="hint">zoom</span>
                                    </div>

                                    <div class="gamebar-right">
                                        <button class="btn btn-secondary" type="button" @onclick="PlayPreviewAsync" disabled="@(!viewerInitialized || isSaving)">
                                            @(isPreviewPlaying ? "Detener gesticulaci√≥n" : "Reproducir gesticulaci√≥n")
                                        </button>
                                    </div>
                                </footer>
                            </section>

                            <section class="control-stack">
                                @switch (activePanel)
                                {
                                    case PanelIdentity:
                                        <div class="control-card">
                                            <h3>Identidad corporativa</h3>
                                            <p>Sube el logo que llevar√° la camisa y revisa c√≥mo se adapta a la prenda.</p>
                                            <div class="preview-logo large">
                                                @if (!string.IsNullOrEmpty(CurrentLogoUrl))
                                                {
                                                    <img src="@CurrentLogoUrl" alt="Logo corporativo" />
                                                }
                                                else
                                                {
                                                    <span>Logo</span>
                                                }
                                            </div>
                                            <InputFile OnChange="OnLogoSelectedAsync" accept="image/png,image/jpeg" disabled="@isSaving" />
                                            <small class="form-text">Formatos PNG o JPG. Tama√±o m√°ximo 2 MB.</small>
                                        </div>
                                        break;

                                    case PanelOutfit:
                                        <div class="control-card">
                                            <h3>Vestimenta y estilo</h3>
                                            <p>Elige un preset y ajusta detalles como en un creador de personaje.</p>

                                            <h4 class="section-title">Presets</h4>
                                            <div class="preset-grid">
                                                @foreach (var outfit in Outfits)
                                                {
                                                    var active = outfit.Value.Equals(config.Vestimenta, StringComparison.OrdinalIgnoreCase);
                                                    <button type="button"
                                                            class="preset-tile @(active ? "active" : null)"
                                                            title="@outfit.Label"
                                                            @onclick="() => SelectOutfitAsync(outfit.Value)"
                                                            disabled="@isSaving">
                                                        <img src="@($"/img/{outfit.Value}.jpg")" alt="@outfit.Label" />
                                                        <span>@outfit.Label</span>
                                                    </button>
                                                }
                                            </div>

                                            <div class="section-divider"></div>

                                            <h4 class="section-title">Color de cabello</h4>
                                            <div class="swatch-row">
                                                @foreach (var hair in HairColors)
                                                {
                                                    var active = hair.Value.Equals(config.ColorCabello, StringComparison.OrdinalIgnoreCase);
                                                    <button type="button"
                                                            class="swatch @(active ? "active" : null)"
                                                            title="@hair.Label"
                                                            style="--sw:@(hair.Hex is null ? "#ccc" : $"#{hair.Hex.Value:X6}")"
                                                            @onclick="() => SelectHairColorAsync(hair.Value)"
                                                            disabled="@isSaving">
                                                        <span></span>
                                                    </button>
                                                }
                                            </div>

                                            <div class="quick-actions">
                                                <button type="button" class="icon-btn" title="Aleatorio" @onclick="RandomizeLook">üé≤</button>
                                                <button type="button" class="icon-btn" title="Reiniciar" @onclick="ResetLook">‚Ü∫</button>
                                            </div>
                                        </div>
                                        break;

                                    case PanelVoice:
                                        <div class="control-card" style="display: grid;">
                                            <h3>Idioma y locuci√≥n</h3>
                                            <p>Define la voz neutra que anunciar√° los turnos. Puedes cambiarla cuando necesites campa√±as biling√ºes.</p>
                                            <div class="mb-3">
                                                <label class="form-label">Idioma</label>
                                                <select class="form-control" value="@config.Idioma" @onchange="OnLanguageChangedAsync" disabled="@isSaving">
                                                    @foreach (var language in Languages)
                                                    {
                                                        <option value="@language.Value">@language.Label</option>
                                                    }
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Voz</label>
                                                <select class="form-control" value="@config.Voz" @onchange="OnVoiceChangedAsync" disabled="@isSaving || !AvailableVoices.Any()">
                                                    @if (!AvailableVoices.Any())
                                                    {
                                                        <option value="">Sin voces disponibles</option>
                                                    }
                                                    else
                                                    {
                                                        @foreach (var voice in AvailableVoices)
                                                        {
                                                            <option value="@voice">@voice</option>
                                                        }
                                                    }
                                                </select>
                                            </div>

                                            <div class="voice-hint">
                                                <p>Recuerda que puedes probar el habla presionando ‚ÄúReproducir gesticulaci√≥n‚Äù.</p>
                                                <span>Proveedor actual: @config.ProveedorTts?.ToUpperInvariant()</span>
                                            </div>
                                        </div>
                                        break;

                                    case PanelBackground:
                                        <div class="control-card">
                                            <h3>Escenograf√≠a</h3>
                                            <p>Selecciona el ambiente que acompa√±ar√° a tu asistente virtual en las pantallas del punto de atenci√≥n.</p>
                                            <div class="option-pills">
                                                @foreach (var background in Backgrounds)
                                                {
                                                    var active = background.Value.Equals(config.Fondo, StringComparison.OrdinalIgnoreCase);
                                                    <button type="button" class="option-pill @(active ? "active" : string.Empty)" @onclick="() => SelectBackgroundAsync(background.Value)" disabled="@isSaving">@background.Label</button>
                                                }
                                            </div>
                                            <small class="form-text">Puedes subir fondos personalizados desde el m√≥dulo avanzado o usar las escenas sugeridas por Sentry.</small>
                                        </div>
                                        break;
                                }
                            </section>
                        </div>
                    </div>

                    <footer class="editor-modal-footer">
                        <button type="button" class="btn btn-outline" @onclick="async () => await CloseEditorAsync(false)" disabled="@isSaving">Cancelar</button>
                        <button type="button" class="btn btn-primary" @onclick="async () => await CloseEditorAsync(true)" disabled="@isSaving">Aceptar configuraci√≥n</button>
                    </footer>
                </div>
            </div>
        }
    }
</div>

@code {
    private const long MaxLogoSize = 2 * 1024 * 1024;
    private const string DefaultProvider = "polly";

    private readonly SelectorModel selector = new();
    private AvatarConfigDto? config;
    private IReadOnlyDictionary<string, IReadOnlyList<string>> voiceCatalog = new Dictionary<string, IReadOnlyList<string>>(StringComparer.OrdinalIgnoreCase);
    private bool isLoading;
    private bool isSaving;
    private string? errorMessage;
    private string? successMessage;
    private bool viewerInitialized;
    private bool pendingViewerUpdate;
    private ElementReference avatarCanvasRef;
    private bool hasRenderedOnce;
    private bool isPreviewPlaying;
    private bool showEditorModal;
    private string activePanel = PanelIdentity;
    private bool initializingViewer; // üëà nuevo
    

    private static readonly IReadOnlyList<OutfitOption> Outfits = new List<OutfitOption>
    {
        new("predeterminado", "Uniforme corporativo", "models/Avatar.glb"),
        new("traje", "Traje ejecutivo", "models/traje.glb"),
        new("vestido", "Vestido formal", "models/vestido.glb")
    };

    private static readonly IReadOnlyDictionary<string, string> LegacyOutfitMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["corporativo"] = "predeterminado",
        ["ejecutivo"] = "traje",
        ["casual"] = "vestido"
    };

    private static readonly IReadOnlyList<HairColorOption> HairColors = new List<HairColorOption>
    {
        new("predeterminado", "Predeterminado", null),
        new("negro", "Negro", 0x1f1b18),
        new("castano", "Casta√±o", 0x4b2e21),
        new("rubio", "Rubio", 0xd3b26b)
    };

    private static readonly IReadOnlyList<OptionItem> Backgrounds = new List<OptionItem>
    {
        new("oficina", "Lobby corporativo", "preview-office"),
        new("moderno", "Sala moderna", "preview-modern"),
        new("naturaleza", "Exterior natural", "preview-nature")
    };

    private static readonly IReadOnlyList<LanguageOption> Languages = new List<LanguageOption>
    {
        new("es", "Espa√±ol neutro"),
        new("pt", "Portugu√©s (Brasil)"),
        new("en", "Ingl√©s internacional")
    };

    private const string PanelIdentity = "identidad";
    private const string PanelOutfit = "vestimenta";
    private const string PanelVoice = "voz";
    private const string PanelBackground = "fondo";

    private IEnumerable<string> AvailableVoices
    {
        get
        {
            if (config is null)
            {
                return Enumerable.Empty<string>();
            }

            var idioma = string.IsNullOrWhiteSpace(config.Idioma) ? Languages[0].Value : config.Idioma;
            return voiceCatalog.TryGetValue(idioma, out var voices) ? voices : Enumerable.Empty<string>();
        }
    }

    private string GetSidebarButtonClass(string panel) => panel == activePanel ? "sidebar-btn active" : "sidebar-btn";

    private void SetActivePanel(string panel)
    {
        activePanel = panel;
    }

    private string? CurrentLogoUrl => config is null ? null : ApiClient.BuildAssetUrl(config.LogoPath);
    private string GetModelUrlForCurrentConfig() => GetModelUrlForOutfit(config?.Vestimenta);

    private string GetModelUrlForOutfit(string? outfit)
    {
        var option = FindOutfitOption(outfit);
        var path = option.ModelPath;
        return ApiClient.BuildAssetUrl(path) ?? path;
    }

    private string GetOutfitLabel(string? value) => FindOutfitOption(value).Label;

    private string GetBackgroundLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return Backgrounds[0].Label;
        }

        var match = Backgrounds.FirstOrDefault(b => b.Value.Equals(value, StringComparison.OrdinalIgnoreCase));
        return match?.Label ?? Backgrounds[0].Label;
    }

    private static OutfitOption FindOutfitOption(string? value)
    {
        if (!string.IsNullOrWhiteSpace(value))
        {
            var match = Outfits.FirstOrDefault(o => o.Value.Equals(value, StringComparison.OrdinalIgnoreCase));
            if (match is not null)
            {
                return match;
            }

            if (LegacyOutfitMap.TryGetValue(value, out var mapped))
            {
                var mappedOption = Outfits.FirstOrDefault(o => o.Value.Equals(mapped, StringComparison.OrdinalIgnoreCase));
                if (mappedOption is not null)
                {
                    return mappedOption;
                }
            }
        }

        return Outfits[0];
    }

    private static string NormalizeOutfit(string? value) => FindOutfitOption(value).Value;

    protected override async Task OnInitializedAsync()
    {
        await LoadVoicesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        hasRenderedOnce = true;

        if (config is null || !showEditorModal)
        {
            return;
        }

        if (!viewerInitialized || pendingViewerUpdate)
        {
            pendingViewerUpdate = false;
            await InitializeOrUpdateViewerAsync();
        }
    }

    private async Task LoadVoicesAsync()
    {
        try
        {
            voiceCatalog = await ApiClient.GetVoicesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "No fue posible obtener el cat√°logo de voces.");
            voiceCatalog = new Dictionary<string, IReadOnlyList<string>>(StringComparer.OrdinalIgnoreCase);
        }
    }

    private async Task LoadConfigAsync()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            selector.Trim();
            await StopPreviewIfPlayingAsync();
            await DisposeViewerAsync();

            var result = await ApiClient.GetConfigAsync(selector.Empresa, selector.Sede);
            config = result;
            NormalizeConfig();
            activePanel = PanelIdentity;
            OpenEditor();
            successMessage = "Configuraci√≥n cargada correctamente.";
            RequestViewerRefresh();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar la configuraci√≥n de avatar");
            errorMessage = "No fue posible obtener la configuraci√≥n. Verifica la API y vuelve a intentarlo.";
            config = null;
            activePanel = PanelIdentity;
            showEditorModal = false;
            await StopPreviewIfPlayingAsync();
            await DisposeViewerAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NormalizeConfig()
    {
        if (config is null)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(config.ProveedorTts))
        {
            config.ProveedorTts = DefaultProvider;
        }

        if (string.IsNullOrWhiteSpace(config.Idioma))
        {
            config.Idioma = Languages[0].Value;
        }

        if (!voiceCatalog.TryGetValue(config.Idioma, out var voices) || voices.Count == 0)
        {
            config.Voz = null;
        }
        else if (string.IsNullOrWhiteSpace(config.Voz) || !voices.Contains(config.Voz))
        {
            config.Voz = voices[0];
        }

        config.Vestimenta = NormalizeOutfit(config.Vestimenta);

        if (string.IsNullOrWhiteSpace(config.Fondo))
        {
            config.Fondo = Backgrounds[0].Value;
        }

        if (string.IsNullOrWhiteSpace(config.ColorCabello) || !HairColors.Any(h => h.Value.Equals(config.ColorCabello, StringComparison.OrdinalIgnoreCase)))
        {
            config.ColorCabello = HairColors[0].Value;
        }
    }

    private async Task PersistConfigAsync(string successText)
    {
        if (config is null)
        {
            return;
        }

        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var update = new AvatarConfigUpdate
            {
                Vestimenta = config.Vestimenta,
                Fondo = config.Fondo,
                ProveedorTts = config.ProveedorTts ?? DefaultProvider,
                Voz = config.Voz,
                Idioma = config.Idioma,
                ColorCabello = config.ColorCabello
            };

            config = await ApiClient.UpdateConfigAsync(selector.Empresa, selector.Sede, update);
            NormalizeConfig();
            successMessage = successText;
            RequestViewerRefresh();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar la configuraci√≥n");
            errorMessage = "Ocurri√≥ un problema al guardar los cambios. Por favor, intenta nuevamente.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task OnLogoSelectedAsync(InputFileChangeEventArgs args)
    {
        if (config is null)
        {
            return;
        }

        var file = args.File;
        if (file is null)
        {
            return;
        }

        if (file.Size > MaxLogoSize)
        {
            errorMessage = "El archivo supera el tama√±o permitido (2 MB).";
            return;
        }

        try
        {
            await using var stream = file.OpenReadStream(MaxLogoSize);
            var path = await ApiClient.UploadLogoAsync(selector.Empresa, selector.Sede, stream, file.Name, file.ContentType ?? "application/octet-stream");
            if (!string.IsNullOrWhiteSpace(path))
            {
                config.LogoPath = path;
                successMessage = "Logo actualizado correctamente.";
                RequestViewerRefresh();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al subir el logo");
            errorMessage = "No fue posible subir el logo. Verifica el formato y vuelve a intentarlo.";
        }
    }

    private async Task SelectOutfitAsync(string value)
    {
        if (config is null)
        {
            return;
        }

        var normalized = NormalizeOutfit(value);
        if (string.Equals(config.Vestimenta, normalized, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        config.Vestimenta = normalized;
        await PersistConfigAsync("Vestimenta actualizada.");
    }

    private async Task SelectBackgroundAsync(string value)
    {
        if (config is null || string.Equals(config.Fondo, value, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        config.Fondo = value;
        await PersistConfigAsync("Fondo actualizado.");
    }

    private async Task SelectHairColorAsync(string value)
    {
        if (config is null || string.Equals(config.ColorCabello, value, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        config.ColorCabello = value;
        await PersistConfigAsync("Color de cabello actualizado.");
    }

    private async Task OnLanguageChangedAsync(ChangeEventArgs args)
    {
        if (config is null)
        {
            return;
        }

        var selected = args.Value?.ToString() ?? Languages[0].Value;
        if (string.Equals(config.Idioma, selected, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        config.Idioma = selected;
        NormalizeConfig();
        await PersistConfigAsync("Idioma actualizado.");
    }

    private async Task OnVoiceChangedAsync(ChangeEventArgs args)
    {
        if (config is null)
        {
            return;
        }

        var selected = args.Value?.ToString();
        if (string.Equals(config.Voz, selected, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        config.Voz = string.IsNullOrWhiteSpace(selected) ? null : selected;
        await PersistConfigAsync("Voz actualizada.");
    }

    private string GetPreviewClass()
    {
        if (config is null)
        {
            return $"preview-stage {Backgrounds[0].CssClass}";
        }

        var match = Backgrounds.FirstOrDefault(b => b.Value.Equals(config.Fondo, StringComparison.OrdinalIgnoreCase));
        return $"preview-stage {match?.CssClass ?? Backgrounds[0].CssClass}";
    }

    private static string GetLanguageLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return Languages[0].Label;
        }

        var match = Languages.FirstOrDefault(l => l.Value.Equals(value, StringComparison.OrdinalIgnoreCase));
        return match?.Label ?? Languages[0].Label;
    }
    
    

    private async Task InitializeOrUpdateViewerAsync()
    {
        if (config is null || !hasRenderedOnce || !showEditorModal)
        {
            return;
        }

        if (initializingViewer) // üëà evita doble init solapado
            return;

        try
        {
            var options = new
            {
                modelUrl = GetModelUrlForCurrentConfig(),
                logoUrl = CurrentLogoUrl,
                outfit = config.Vestimenta,
                background = config.Fondo,
                hairColor = GetHairColorHex(config.ColorCabello)
            };

            if (!viewerInitialized)
            {
                await JS.InvokeVoidAsync("AvatarViewer.init", avatarCanvasRef, options);
                viewerInitialized = true;
            }
            else
            {
                await JS.InvokeVoidAsync("AvatarViewer.updateAppearance", options);
            }
        }
        catch (JSException jsEx)
        {
            Logger.LogError(jsEx, "No fue posible inicializar el visor 3D del avatar");
            errorMessage ??= "El visor 3D no pudo inicializarse. Revisa la consola del navegador.";
        }
    }

    private static int? GetHairColorHex(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return null;
        }

        var match = HairColors.FirstOrDefault(h => h.Value.Equals(value, StringComparison.OrdinalIgnoreCase));
        return match?.Hex;
    }

    private void RequestViewerRefresh()
    {
        if (config is null)
        {
            return;
        }

        pendingViewerUpdate = true;
        if (hasRenderedOnce)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task PlayPreviewAsync()
    {
        if (!viewerInitialized)
        {
            return;
        }

        if (isPreviewPlaying)
        {
            await JS.InvokeVoidAsync("AvatarViewer.stopTalking");
            isPreviewPlaying = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        await JS.InvokeVoidAsync("AvatarViewer.playTalking", 2600);
        isPreviewPlaying = true;
        _ = Task.Run(async () =>
        {
            await Task.Delay(2600);
            isPreviewPlaying = false;
            await InvokeAsync(StateHasChanged);
        });
    }

    public async ValueTask DisposeAsync()
    {
        await StopPreviewIfPlayingAsync();
        await DisposeViewerAsync();
    }

    private void OpenEditor()
    {
        if (config is null)
        {
            return;
        }

        showEditorModal = true;
        activePanel = PanelIdentity;
        isPreviewPlaying = false;
        pendingViewerUpdate = true;
        viewerInitialized = false;
    }

    private async Task CloseEditorAsync(bool accepted)
    {
        if (isSaving)
        {
            return;
        }

        await StopPreviewIfPlayingAsync();
        await DisposeViewerAsync();

        showEditorModal = false;
        pendingViewerUpdate = false;
        viewerInitialized = false;

        if (accepted)
        {
            successMessage = "Vista previa confirmada. Los ajustes permanecen guardados.";
        }

        StateHasChanged();
    }

    private async Task DisposeViewerAsync()
    {
        if (!viewerInitialized)
        {
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("AvatarViewer.dispose");
        }
        catch (JSException)
        {
            // Ignorar errores de limpieza cuando el visor ya no existe.
        }

        viewerInitialized = false;
    }

    private async Task StopPreviewIfPlayingAsync()
    {
        if (!isPreviewPlaying)
        {
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("AvatarViewer.stopTalking");
        }
        catch (JSException)
        {
            // Ignorar errores de sincronizaci√≥n cuando el visor se cierra.
        }

        isPreviewPlaying = false;
    }

    private sealed class SelectorModel
    {
        [Required(ErrorMessage = "La empresa es obligatoria.")]
        [MaxLength(64, ErrorMessage = "M√°ximo 64 caracteres.")]
        public string Empresa { get; set; } = string.Empty;

        [Required(ErrorMessage = "La sede es obligatoria.")]
        [MaxLength(64, ErrorMessage = "M√°ximo 64 caracteres.")]
        public string Sede { get; set; } = string.Empty;

        public void Trim()
        {
            Empresa = Empresa.Trim();
            Sede = Sede.Trim();
        }
    }

    private async Task RandomizeLook()
    {
        if (config is null) return;
        var rnd = new Random();
        var outfit = Outfits[rnd.Next(Outfits.Count)].Value;
        var hair = HairColors[rnd.Next(HairColors.Count)].Value;
        config.Vestimenta = outfit;
        config.ColorCabello = hair;
        await PersistConfigAsync("Apariencia aleatoria aplicada.");
    }

    private async Task ResetLook()
    {
        if (config is null) return;
        config.Vestimenta = Outfits[0].Value;
        config.ColorCabello = HairColors[0].Value;
        await PersistConfigAsync("Apariencia restablecida.");
    }

    private Task TurntableAsync() => JS.InvokeVoidAsync("AvatarViewer.turntable", 3000).AsTask();
    private Task FrameAsync()      => JS.InvokeVoidAsync("AvatarViewer.frame").AsTask();
    private Task ScreenshotAsync() => JS.InvokeVoidAsync("AvatarViewer.screenshot").AsTask();



    private sealed record OutfitOption(string Value, string Label, string ModelPath);

    private sealed record OptionItem(string Value, string Label, string? CssClass = null);

    private sealed record LanguageOption(string Value, string Label);

    private sealed record HairColorOption(string Value, string Label, int? Hex);
}
