@page "/editor"
@using AvatarAdmin.Services
@using AvatarAdmin.Models
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Components.Forms
@inject AvatarApiClient Api
@inject AuthState Auth
@inject IJSRuntime JS
@inject ILogger<Editor> Log

<PageTitle>Editor de Avatar</PageTitle>

<AuthGuard>
<div class="vg-shell" aria-busy="@loading" aria-live="polite">

  <!-- ===== RIEL IZQUIERDO ===== -->
  <aside class="vg-rail" aria-label="Panel de configuraci√≥n" @ref="railRef">
    <header class="vg-rail-head">
      <div class="brand">
        <img src="/img/Logo_Sentry.png" alt="Sentry" class="brand-logo"/>
        <div class="brand-copy">
          <strong>Avatar Studio</strong>
          <small>@(empresa ?? "‚Äî") / @(sede ?? "‚Äî")</small>
        </div>
      </div>
      <div class="rail-badge" aria-hidden="true"><span class="dot"></span> ONLINE</div>
    </header>

    <nav class="vg-rail-nav" role="tablist" aria-label="Secciones">
      <button @ref="btnIdentidadRef"
              class="@RailBtn("identidad")"
              role="tab"
              aria-selected="@(panel=="identidad")"
              @onclick="@(()=>OnPanelClick("identidad", btnIdentidadRef))">
        <span class="ic">üè∑Ô∏è</span><b>Identidad</b>
      </button>

      <button @ref="btnVestimentaRef"
              class="@RailBtn("vestimenta")"
              role="tab"
              aria-selected="@(panel=="vestimenta")"
              @onclick="@(()=>OnPanelClick("vestimenta", btnVestimentaRef))">
        <span class="ic">üß•</span><b>Vestimenta</b>
      </button>

      <button @ref="btnVozRef"
              class="@RailBtn("voz")"
              role="tab"
              aria-selected="@(panel=="voz")"
              @onclick="@(()=>OnPanelClick("voz", btnVozRef))">
        <span class="ic">üé§</span><b>Voz</b>
      </button>

      <button @ref="btnFondoRef"
              class="@RailBtn("fondo")"
              role="tab"
              aria-selected="@(panel=="fondo")"
              @onclick="@(()=>OnPanelClick("fondo", btnFondoRef))">
        <span class="ic">üåÜ</span><b>Escena</b>
      </button>
    </nav>

    <div class="vg-rail-form">
      <div class="vg-form">
        <div class="vg-field">
          <label for="empresa">Empresa</label>
          <input id="empresa" class="form-control" @bind="empresa" placeholder="ACME" />
          <small class="hint">Nombre corto o c√≥digo interno.</small>
        </div>

        <div class="vg-field">
          <label for="sede">Sede</label>
          <input id="sede" class="form-control" @bind="sede" placeholder="CENTRO" />
          <small class="hint">Ej. Centro, Norte, Sur‚Ä¶</small>
        </div>

        <button class="btn btn-outline-light w-100 btn-load" @onclick="LoadAsync" disabled="@loading">
          @(loading ? "Cargando‚Ä¶" : "Cargar configuraci√≥n")
        </button>
      </div>

      <div class="rail-actions">
        <button class="btn btn-primary w-100" @onclick="SaveAsync" disabled="@saving">
          @(saving ? "Guardando‚Ä¶" : "Guardar cambios")
        </button>
      </div>
    </div>

    @if (showSub)
    {
      <section class="vg-sub @(subClosing ? "is-closing" : "is-open")"
               role="region"
               aria-label="Opciones de la secci√≥n"
               style="top:@($"{subTop}px"); left: calc(100% + .6rem);">
        @switch (panel)
        {
          case "identidad":
            <div class="sub-card">
              <header class="sub-head"><h6>Logo corporativo</h6></header>
              <div class="sub-body">
                <div class="vg-logo-preview" title="Previsualizaci√≥n del logo">
                  @if (!string.IsNullOrWhiteSpace(logoUrl))
                  { <img src="@logoUrl" alt="Logo corporativo" /> } else { <span>Sin logo</span> }
                </div>
                <div class="u-row">
                  <InputFile OnChange="OnLogoPicked" accept=".png,.jpg,.jpeg,.webp" />
                  <small class="muted">Tip: arrastra y suelta la imagen sobre el lienzo.</small>
                </div>
              </div>
            </div>
            break;

          case "vestimenta":
            <div class="sub-card">
              <header class="sub-head"><h6>Preset de vestimenta</h6></header>
              <div class="sub-body">
                <div class="preset-grid">
                  @foreach (var opt in outfitOptions)
                  {
                    var active = string.Equals(vestimenta, opt.Value, StringComparison.OrdinalIgnoreCase);
                    <button class="preset-tile @(active?"active":null)" @onclick="@(()=>SelectOutfit(opt.Value))" aria-pressed="@(active)">
                      <img src="@ThumbOutfit(opt.Value)" alt="@($"Vestimenta {opt.Label}")" />
                      <span>@opt.Label</span>
                    </button>
                  }
                </div>
              </div>
            </div>

            <div class="sub-card">
              <header class="sub-head"><h6>Modelo / vestimenta personalizada</h6></header>
              <div class="sub-body">
                <InputFile OnChange="OnModelPicked" accept=".glb" />
                <small class="muted">Se guarda en tu storage Azure por empresa/sede.</small>
              </div>
            </div>

            <div class="sub-card">
              <header class="sub-head"><h6>Color de cabello</h6></header>
              <div class="sub-body">
                <div class="vg-swatches">
                  @foreach (var c in hairColors)
                  {
                    var active = string.Equals(colorCabello, c.Value, StringComparison.OrdinalIgnoreCase);
                    <button class="swatch @(active?"active":null)" style="--sw:@c.Hex" @onclick="@(()=>SelectHair(c.Value))" title="@c.Label" aria-pressed="@(active)"></button>
                  }
                </div>
              </div>
            </div>
            break;

          case "voz":
            <div class="sub-card">
              <header class="sub-head"><h6>Idioma y voz</h6></header>
              <div class="sub-body grid2">
                <select class="form-select" @bind="idioma" aria-label="Idioma de la voz">
                  @foreach (var kv in voiceMap) { <option value="@kv.Key">@LangLabel(kv.Key)</option> }
                </select>
                <select class="form-select" @bind="voz" aria-label="Voz">
                  @foreach (var v in (voiceMap.TryGetValue(idioma, out var list) ? list : new List<string>()))
                  { <option value="@v">@v</option> }
                </select>
              </div>
            </div>

            <div class="sub-card">
              <header class="sub-head"><h6>Texto de prueba</h6></header>
              <div class="sub-body">
                <textarea class="form-control" rows="2" @bind="textoPreview" aria-label="Texto para previsualizar la voz"></textarea>
                <div class="vg-row-gap">
                  <button class="btn btn-outline-light w-100" @onclick="PreviewVozAsync">üîä Reproducir vista previa</button>
                </div>
              </div>
            </div>
            break;

          case "fondo":
            <div class="sub-card">
              <header class="sub-head"><h6>Escena</h6></header>
              <div class="sub-body">
                <div class="preset-grid">
                  @foreach (var opt in bgOptions)
                  {
                    var active = string.Equals(fondo, opt.Value, StringComparison.OrdinalIgnoreCase);
                    <button class="preset-tile @(active?"active":null)" @onclick="@(()=>SelectBg(opt.Value))" aria-pressed="@(active)">
                      <img src="@ThumbBg(opt.Value)" alt="@($"Escena {opt.Label}")" />
                      <span>@opt.Label</span>
                    </button>
                  }
                </div>
              </div>
            </div>
            break;
        }
      </section>
    }
  </aside>

  <!-- ===== √ÅREA PRINCIPAL ===== -->
  <section class="vg-stage">
    <header class="vg-topbar">
      <div class="vg-tags">
        <span class="tag tag-blue"   title="Usuario">@Auth.Email</span>
        <span class="tag tag-gray"   title="Rol">@($"Rol: {Auth.Role}")</span>
        <span class="tag tag-yellow" title="Contexto">@($"{empresa}/{sede}")</span>
      </div>

      <div class="vg-tools" role="toolbar" aria-label="C√°mara y captura">
        <div class="tool-pack">
          <button class="icon-btn" title="Giro 360¬∞ (A)" @onclick="TurntableAsync" aria-label="Activar giro autom√°tico">‚ü≥</button>
          <button class="icon-btn" title="Centrar (R)"     @onclick="FrameAsync"      aria-label="Centrar">‚äï</button>
        </div>
        <span class="sep" aria-hidden="true"></span>
        <button class="icon-btn icon-btn--danger" title="Captura PNG (S)" @onclick="ScreenshotAsync" aria-label="Capturar PNG">üì∑</button>
      </div>
    </header>

    <!-- Lienzo 3D a pantalla completa -->
    <div class="vg-canvas" aria-label="Vista 3D del avatar">
      <div class="scanlines" aria-hidden="true"></div>
      <canvas @ref="canvasRef" class="avatar-viewer-canvas"></canvas>
      <audio  @ref="audioRef" hidden preload="auto"></audio>

      <div class="vg-canvas-hint" aria-hidden="true">
        <span class="kbd">Arrastra</span> rota ¬∑ <span class="kbd">Rueda</span> zoom ¬∑ <span class="kbd">Shift+Arrastra</span> pan
      </div>

      @if (loading)
      {
        <div class="vg-loading" role="status" aria-live="assertive">
          <div class="spinner"></div>
          <div class="txt">Cargando avatar‚Ä¶</div>
        </div>
      }
    </div>
  </section>
</div>
</AuthGuard>

@inject NavigationManager Nav
@code {
  // ------------ estado ------------
  private ElementReference canvasRef;
  private ElementReference audioRef;

  private ElementReference railRef;
  private ElementReference btnIdentidadRef, btnVestimentaRef, btnVozRef, btnFondoRef;

  private string empresa = "ACME";
  private string sede    = "CENTRO";

  private string? vestimenta;
  private string? fondo;
  private string? colorCabello;
  private string? logoUrl;
  private string? modelUrl;

  private string panel = "identidad";
  private bool saving;
  private bool loading;

  // Submen√∫
  private bool showSub = false;
  private bool subClosing = false;
  private double subTop = 8;

  // Voz
  private string idioma = "es";
  private string voz    = "es-CO-SalomeNeural";
  private string textoPreview = "Hola, soy tu avatar Sentry. Estoy listo para ayudarte.";
  private Dictionary<string, List<string>> voiceMap = new();

  // ------------ cat√°logo UI ------------
  private readonly (string Value, string Label)[] outfitOptions = new[] {
    ("corporativo","Corporativo"), ("ejecutivo","Ejecutivo"), ("casual","Casual")
  };
  private readonly (string Value, string Label)[] bgOptions = new[] {
    ("oficina","Lobby corporativo"), ("moderno","Sala moderna"), ("naturaleza","Exterior natural")
  };
  private readonly (string Value, string Label, string Hex)[] hairColors = new[] {
    ("predeterminado","Predeterminado","#2b2b2b"), ("negro","Negro","#1f1b18"),
    ("castano","Casta√±o","#4b2e21"), ("rubio","Rubio","#d3b26b")
  };

  // ------------ helpers ------------
  private string RailBtn(string k) => $"vg-rail-btn {(panel==k && showSub ? "active" : "")}";

  // Convierte rutas del backend a absolutas (evita 404 en el puerto 5168)
  private string Abs(string? path)
  {
    if (string.IsNullOrWhiteSpace(path)) return "";
    if (Uri.TryCreate(path, UriKind.Absolute, out var abs)) return abs.ToString();
    var baseUrl = Api.BaseUrl?.TrimEnd('/') ?? "";
    return string.IsNullOrEmpty(baseUrl) ? path : $"{baseUrl}/{path.TrimStart('/')}";
  }

  private async Task<string?> ResolveAssetUrlAsync(string? path)
  {
    if (string.IsNullOrWhiteSpace(path)) return null;
    try { return await Api.GetAssetUrlAsync(path) ?? Abs(path); }
    catch (Exception ex)
    {
      Log.LogWarning(ex, "No se pudo resolver la URL p√∫blica para {Path}", path);
      return Abs(path);
    }
  }

  private static readonly Dictionary<string, string> OutfitModelPaths = new(StringComparer.OrdinalIgnoreCase)
  {
    ["corporativo"] = "/Avatar.glb",
    ["ejecutivo"] = "/traje.glb",
    ["casual"] = "/vestido.glb"
  };

  private string DefaultModelUrl => "/Avatar.glb";

  private static string? OutfitToModel(string? outfit)
  {
    if (string.IsNullOrWhiteSpace(outfit)) return null;
    return OutfitModelPaths.TryGetValue(outfit, out var model) ? model : null;
  }

  private async Task OnPanelClick(string key, ElementReference btnRef)
  {
    if (panel == key && showSub && !subClosing)
    {
      await HideSubWithAnimation();
      return;
    }

    panel = key;
    subClosing = false;
    showSub = true;

    try
    {
      subTop = await JS.InvokeAsync<double>("EditorHelpers.relativeTop", btnRef, railRef);
      subTop = Math.Max(8.0, subTop - 4);
    }
    catch { subTop = 8; }

    StateHasChanged();
  }

  private async Task HideSubWithAnimation()
  {
    if (!showSub || subClosing) return;
    subClosing = true; StateHasChanged();
    await Task.Delay(190);
    showSub = false;
    subClosing = false;
    StateHasChanged();
  }

  private static string LangLabel(string k) => k switch {
    "es" => "Espa√±ol", "en" => "Ingl√©s", "pt" => "Portugu√©s (BR)", _ => k.ToUpperInvariant()
  };

  private static string ThumbOutfit(string val) => $"/img/thumbs/outfit-{val}.jpg";
  private static string ThumbBg(string val)     => $"/img/thumbs/bg-{val}.jpg";

  // ------------ ciclo ------------
  protected override async Task OnInitializedAsync()
  {
    await Auth.EnsureHydratedAsync();

    if (Auth.IsAuthenticated)
    {
      try { voiceMap = await Api.GetVoicesAsync(); }
      catch (Exception ex)
      {
        Log.LogWarning(ex, "No se pudo obtener el mapa de voces");
        voiceMap = new();
      }

      NormalizarVoz();
    }
  }

  private IJSObjectReference? _viewerModule;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
      if (!firstRender) return;

      try
      {
          modelUrl ??= DefaultModelUrl;
          _viewerModule = await JS.InvokeAsync<IJSObjectReference>("import", "/js/avatarViewer.js");

          await _viewerModule.InvokeVoidAsync("init", canvasRef, new {
              modelUrl,
              audioEl    = audioRef,
              logoUrl    = logoUrl,
              outfit     = vestimenta,
              background = fondo,
              hairColor  = ColorToHex(colorCabello) ?? 0x2b2b2b,
          });
      }
      catch (JSDisconnectedException) { }
      catch (Exception ex)
      {
          Log.LogError(ex, "Fallo inicializando AvatarViewer");
          loading = false;
          StateHasChanged();
      }
  }

  // ------------ acciones ------------
  private async Task LoadAsync()
  {
    loading = true; StateHasChanged();
    try
    {
      var cfg = await Api.GetConfigAsync(empresa, sede);
      vestimenta   = cfg.Vestimenta;
      fondo        = cfg.Fondo;
      colorCabello = cfg.ColorCabello;
      logoUrl      = await ResolveAssetUrlAsync(cfg.LogoPath);

      if (!string.IsNullOrWhiteSpace(cfg.Vestimenta) && (cfg.Vestimenta.Contains('/') || cfg.Vestimenta.EndsWith(".glb", StringComparison.OrdinalIgnoreCase)))
      {
        modelUrl = await ResolveAssetUrlAsync(cfg.Vestimenta) ?? DefaultModelUrl;
      }
      else
      {
        modelUrl = OutfitToModel(cfg.Vestimenta) ?? modelUrl ?? DefaultModelUrl;
      }

      if (_viewerModule is not null)
      {
        await _viewerModule.InvokeVoidAsync("updateAppearance", new {
          modelUrl   = modelUrl ?? DefaultModelUrl,
          logoUrl    = logoUrl,
          outfit     = vestimenta,
          background = fondo,
          hairColor  = ColorToHex(colorCabello)
        });
      }
    }
    finally { loading = false; StateHasChanged(); }
  }

  private async Task SaveAsync()
  {
    saving = true;
    try
    {
      var upd = new AvatarConfigUpdate {
        Vestimenta = vestimenta, Fondo = fondo, ColorCabello = colorCabello, Idioma = idioma, Voz = voz
      };
      var saved = await Api.UpdateConfigAsync(empresa, sede, upd);
      vestimenta = saved.Vestimenta; fondo = saved.Fondo; colorCabello = saved.ColorCabello; logoUrl = Abs(saved.LogoPath);
    }
    finally { saving = false; }
  }

  private async Task OnLogoPicked(InputFileChangeEventArgs e)
  {
    var f = e.File; if (f is null) return;
    await using var s = f.OpenReadStream(2 * 1024 * 1024);
    var saved = await Api.UploadLogoAsync(empresa, sede, s, f.Name, f.ContentType ?? "application/octet-stream");
    logoUrl = await ResolveAssetUrlAsync(saved.LogoPath);
    StateHasChanged();
  }

  private async Task OnModelPicked(InputFileChangeEventArgs e)
  {
    var f = e.File; if (f is null) return;
    await using var s = f.OpenReadStream(60 * 1024 * 1024);
    var saved = await Api.UploadOutfitAsync(empresa, sede, s, f.Name, f.ContentType ?? "application/octet-stream");

    vestimenta = saved.Vestimenta;
    modelUrl = await ResolveAssetUrlAsync(saved.Vestimenta) ?? modelUrl ?? DefaultModelUrl;

    if (_viewerModule is not null)
    {
      await _viewerModule.InvokeVoidAsync("updateAppearance", new { modelUrl, outfit = vestimenta });
    }
  }

  private async Task SelectOutfit(string v)
  {
    vestimenta = v;
    if (_viewerModule is not null)
    {
      modelUrl = OutfitToModel(vestimenta) ?? modelUrl ?? DefaultModelUrl;
      await _viewerModule.InvokeVoidAsync("updateAppearance", new { outfit = vestimenta, modelUrl });
    }
  }

  private async Task SelectBg(string v)
  {
    fondo = v;
    if (_viewerModule is not null)
    {
      await _viewerModule.InvokeVoidAsync("updateAppearance", new { background = fondo });
    }
  }

  private async Task SelectHair(string v)
  {
    colorCabello = v;
    if (_viewerModule is not null)
    {
      await _viewerModule.InvokeVoidAsync("updateAppearance", new { hairColor = ColorToHex(colorCabello) });
    }
  }

  private async Task PreviewVozAsync()
  {
    try
    {
      var req = new AnnouncementRequest {
        Empresa = empresa, Sede = sede, Modulo = "A1", Turno = "0001", Nombre = string.IsNullOrWhiteSpace(textoPreview) ? "Invitado" : textoPreview
      };
      var res = await Api.AnnounceAsync(req, idioma, voz);
      var audioUrl = Abs(res.AudioUrl);

      if (_viewerModule is not null)
      {
        await _viewerModule.InvokeVoidAsync("speak", audioUrl, res.Visemas);
      }
    }
    catch (Exception ex)
    {
      Log.LogError(ex, "PreviewVozAsync fall√≥");
    }
  }

  private void NormalizarVoz()
  {
    if (voiceMap.Count == 0) return;

    if (!voiceMap.TryGetValue(idioma, out var lista) || lista.Count == 0)
    {
      idioma = voiceMap.Keys.First();
      lista = voiceMap[idioma];
    }

    if (!lista.Contains(voz) && lista.Count > 0)
    {
      voz = lista[0];
    }
  }

  private static int? ColorToHex(string? key) => key?.ToLowerInvariant() switch {
    "negro" => 0x1f1b18, "castano" => 0x4b2e21, "rubio" => 0xd3b26b, _ => 0x2b2b2b
  };

  private Task TurntableAsync()  => _viewerModule?.InvokeVoidAsync("turntable", 3000).AsTask() ?? Task.CompletedTask;
  private Task FrameAsync()      => _viewerModule?.InvokeVoidAsync("frame").AsTask() ?? Task.CompletedTask;
  private Task ScreenshotAsync() => _viewerModule?.InvokeVoidAsync("screenshot").AsTask() ?? Task.CompletedTask;

  public async ValueTask DisposeAsync()
  {
    try
    {
      if (_viewerModule is not null)
      {
        await _viewerModule.InvokeVoidAsync("dispose");
        await _viewerModule.DisposeAsync();
      }
    }
    catch (JSDisconnectedException) { }
  }
}
