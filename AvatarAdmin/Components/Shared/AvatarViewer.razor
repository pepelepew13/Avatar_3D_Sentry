@using Microsoft.JSInterop
@implements IAsyncDisposable

<div class="viewer-wrapper vg-stage">
  <canvas @ref="canvas" class="avatar-viewer-canvas"></canvas>

  @if (ShowHud)
  {
    <div class="viewer-overlay">
      <div class="viewer-left">
        <span class="viewer-pill">Vista 3D</span>
        <span class="hint">
          <span class="kbd">Arrastra</span> rota ¬∑
          <span class="kbd">Rueda</span> zoom ¬∑
          <span class="kbd">Shift+Arrastra</span> pan
        </span>
      </div>

      <div class="viewer-tools">
        <div class="preset">
          <button class="icon-btn" title="Cuerpo entero (1)" @onclick='() => Call("setCameraPreset","full")'>üßç</button>
          <button class="icon-btn" title="Plano medio (2)"  @onclick='() => Call("setCameraPreset","waist")'>üßç‚Äç‚ôÇÔ∏è</button>
          <button class="icon-btn" title="Pecho (3)"        @onclick='() => Call("setCameraPreset","chest")'>üëî</button>
          <button class="icon-btn" title="Cabeza (4)"       @onclick='() => Call("setCameraPreset","head")'>üôÇ</button>
          <span class="sep"></span>
        </div>

        <button class="icon-btn" title="Reset c√°mara (R)" @onclick='() => Call("resetCamera")'>‚Ü∫</button>
        <button class="icon-btn" title="Auto-rotar (A)"   @onclick="ToggleRotate">@((autoRotate ? "‚è∏" : "‚ü≥"))</button>
        <button class="icon-btn" title="Luz on/off (L)"   @onclick='() => Call("toggleLight")'>üí°</button>
        <button class="icon-btn" title="Suelo on/off (G)" @onclick='() => Call("toggleGround")'>‚éö</button>
        <button class="icon-btn" title="Captura PNG (S)"  @onclick="Screenshot">üì∏</button>
      </div>
    </div>
  }
</div>

@code {
  private ElementReference canvas;
  private IJSObjectReference? module;
  private IJSObjectReference? viewerInstance;
  private bool initialized;
  private bool autoRotate;

  [Inject] private IJSRuntime JS { get; set; } = default!;

  [Parameter] public string ModelPath { get; set; } = "/Avatar.glb";
  [Parameter] public string? LogoUrl { get; set; }
  [Parameter] public string? Outfit { get; set; }
  [Parameter] public string? Background { get; set; }
  [Parameter] public bool ShowHud { get; set; } = true;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;
    module = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/Shared/AvatarViewer.razor.js");
    viewerInstance = await module.InvokeAsync<IJSObjectReference>("createViewer", canvas, new {
      modelUrl = ModelPath, logoUrl = LogoUrl, outfit = Outfit, background = Background
    });
    initialized = true;
    await SyncStateAsync();
  }

  protected override async Task OnParametersSetAsync()
  {
    if (!initialized) return;
    await SyncStateAsync();
  }

  private async Task SyncStateAsync()
  {
    if (viewerInstance is null) return;
    await viewerInstance.InvokeVoidAsync("setLogo", LogoUrl);
    await viewerInstance.InvokeVoidAsync("setOutfit", Outfit);
    await viewerInstance.InvokeVoidAsync("setBackground", Background);
  }

  private async Task Call(string fn, object? arg = null)
  {
    if (viewerInstance is null) return;
    if (arg is null) await viewerInstance.InvokeVoidAsync(fn);
    else             await viewerInstance.InvokeVoidAsync(fn, arg);
  }

  private async Task ToggleRotate()
  {
    autoRotate = !autoRotate;
    if (viewerInstance is not null)
      await viewerInstance.InvokeVoidAsync("setAutoRotate", autoRotate);
  }

  private async Task Screenshot()
  {
    if (viewerInstance is null || module is null) return;
    var dataUrl = await viewerInstance.InvokeAsync<string>("screenshot", 1);
    await module.InvokeVoidAsync("downloadDataUrl", $"avatar_{DateTime.Now:yyyyMMdd_HHmmss}.png", dataUrl);
  }

  // llamado por el Editor
  public async Task SpeakAsync(string audioUrl, IEnumerable<object>? visemas)
  {
    if (viewerInstance is null) return;
    await viewerInstance.InvokeVoidAsync("speak", audioUrl, visemas);
  }

  public async ValueTask DisposeAsync()
  {
    try{
      if (viewerInstance is not null){ await viewerInstance.InvokeVoidAsync("dispose"); await viewerInstance.DisposeAsync(); }
      if (module is not null) await module.DisposeAsync();
    }catch (JSDisconnectedException){ }
  }
}
