@implements IDisposable
@inject AvatarAdmin.Services.AuthState Auth
@inject AvatarAdmin.Services.AuthPersistence Persist

@code {
    protected override void OnInitialized()
    {
        Auth.Changed += OnAuthChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try { await Persist.TryRestoreAsync(Auth); }
        catch { /* silencioso */ }
        finally
        {
            Auth.MarkHydrated();   // SeÃ±al para guards y HttpClient
            StateHasChanged();
        }
    }

    private async void OnAuthChanged()
    {
        try { await Persist.PersistAsync(Auth); } catch { }
        StateHasChanged();
    }

    public void Dispose() => Auth.Changed -= OnAuthChanged;
}
